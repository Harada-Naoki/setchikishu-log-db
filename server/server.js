require("dotenv").config(); // Áí∞Â¢ÉÂ§âÊï∞„ÇíË™≠„ÅøËæº„ÇÄ

const express = require("express");
const cors = require("cors");
const mysql = require("mysql2");

const app = express();
app.use(express.json());
app.use(cors());

// MySQLÊé•Á∂öË®≠ÂÆö
const db = mysql.createConnection({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  charset: "utf8mb4" // Êó•Êú¨Ë™ûÂØæÂøú
});

// MySQL (TiDB) „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂öË®≠ÂÆö
// const db = mysql.createConnection({
//   host: process.env.DB_HOST,
//   user: process.env.DB_USER,
//   password: process.env.DB_PASSWORD,
//   database: process.env.DB_NAME,
//   port: process.env.DB_PORT || 4000,
//   ssl: { rejectUnauthorized: true }  
// });

db.connect(err => {
  if (err) {
    console.error("MySQLÊé•Á∂ö„Ç®„É©„Éº:", err);
  } else {
    console.log("MySQLÊé•Á∂öÊàêÂäü");
  }
});

// üìå Á∑èÂè∞Êï∞„ÅÆÂ∑Æ„ÇíÁ¢∫Ë™ç„Åô„ÇãAPI
app.post("/add-machine", (req, res) => {
  const { storeName, competitorName, category, machines } = req.body;

  db.query("SELECT id FROM stores WHERE store_name = ?", [storeName], (err, storeResult) => {
    if (err || storeResult.length === 0) {
      console.error("‚ùå „Ç®„É©„Éº: Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
      return res.status(400).json({ error: "Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
    }
    const storeId = storeResult[0].id;

    db.query("SELECT id FROM competitor_stores WHERE store_id = ? AND competitor_name = ?", 
      [storeId, competitorName], (err, compResult) => {
      if (err || compResult.length === 0) {
        console.error("‚ùå „Ç®„É©„Éº: Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return res.status(400).json({ error: "Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
      }
      const competitorId = compResult[0].id;

      db.query("SELECT id FROM categories WHERE category_name = ?", [category], (err, catResult) => {
        if (err || catResult.length === 0) {
          console.error("‚ùå „Ç®„É©„Éº: „Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
          return res.status(400).json({ error: "„Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
        }
        const categoryId = catResult[0].id;

        // ‚úÖ Á∑èÂè∞Êï∞„ÇíË®àÁÆó
        const totalQuantity = machines.reduce((sum, { quantity }) => sum + quantity, 0);
        console.log(`üìä Á∑èÂè∞Êï∞ (${category}): ${totalQuantity}`);

        // ‚úÖ Êó¢Â≠ò„ÅÆÁ∑èÂè∞Êï∞„ÇíÂèñÂæó„Åó„Å¶ÊØîËºÉ
        const checkQuery = `SELECT \`${category}\` AS currentTotal FROM competitor_stores WHERE id = ?`;
        db.query(checkQuery, [competitorId], (err, checkResult) => {
          if (err) {
            console.error("‚ùå ÁèæÂú®„ÅÆÁ∑èÂè∞Êï∞ÂèñÂæó„Ç®„É©„Éº:", err);
            return res.status(500).json({ error: "Á∑èÂè∞Êï∞ÂèñÂæó„Ç®„É©„Éº" });
          }

          const currentTotal = checkResult[0]?.currentTotal || 0;
          const difference = Math.abs(currentTotal - totalQuantity);

          if (difference >= 1) {
            return res.json({
              message: `Á∑èÂè∞Êï∞„Å´Â∑ÆÁï∞„Åå„ÅÇ„Çä„Åæ„Åô (${currentTotal} ‚Üí ${totalQuantity})„ÄÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
              needsTotalQuantityConfirmation: true,
              competitorId,  
              category,
              categoryId,    
              totalQuantity, 
              machines,
            });
          }                  

          // **Â∑ÆÂàÜ„ÅåÂ∞è„Åï„ÅÑÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÊõ¥Êñ∞**
          console.log("üõ† `insertOrUpdateMachineData` „Å´Ê∏°„ÅôÂÄ§:", { competitorId, category, categoryId, totalQuantity, machines });
          insertOrUpdateMachineData(competitorId, category, categoryId, totalQuantity, machines, res);
        });
      });
    });
  });
});

app.post("/confirm-machine-update", (req, res) => {
  const { storeName, competitorName, category, machines, totalQuantity } = req.body;

  if (!storeName || !competitorName || !category || !machines || machines.length === 0) {
    console.error("‚ùå „Ç®„É©„Éº: ÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô");
    return res.status(400).json({ error: "ÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô" });
  }

  db.query("SELECT id FROM stores WHERE store_name = ?", [storeName], (err, storeResult) => {
    if (err || storeResult.length === 0) {
      console.error("‚ùå „Ç®„É©„Éº: Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
      return res.status(400).json({ error: "Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
    }
    const storeId = storeResult[0].id;

    db.query("SELECT id FROM competitor_stores WHERE store_id = ? AND competitor_name = ?", 
      [storeId, competitorName], (err, compResult) => {
      if (err || compResult.length === 0) {
        console.error("‚ùå „Ç®„É©„Éº: Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return res.status(400).json({ error: "Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
      }
      const competitorId = compResult[0].id;

      db.query("SELECT id FROM categories WHERE category_name = ?", [category], (err, catResult) => {
        if (err || catResult.length === 0) {
          console.error("‚ùå „Ç®„É©„Éº: „Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
          return res.status(400).json({ error: "„Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
        }
        const categoryId = catResult[0].id;

        const totalQuantity = machines.reduce((sum, { quantity }) => sum + quantity, 0);

        console.log("üõ† `confirm-machine-update` „Å´Ê∏°„ÅôÂÄ§:", { competitorId, category, categoryId, totalQuantity, machines });

        insertOrUpdateMachineData(competitorId, category, categoryId, totalQuantity, machines, res);
      });
    });
  });
});

// üìå UI„ÅßÁ¢∫Ë™çÂæå„Å´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞API
app.post("/confirm-update-machine", (req, res) => {
  console.log("üõ† Âèó‰ø°„Åó„Åü„É™„ÇØ„Ç®„Çπ„Éà„Éá„Éº„Çø:", req.body);

  const { competitorId, categoryId, totalQuantity, machines, updatedAt } = req.body;

  if (!Array.isArray(machines) || machines.length === 0) {
    console.error("‚ùå „Ç®„É©„Éº: `machines` „ÅåÁÑ°Âäπ„Åß„Åô:", machines);
    return res.status(400).json({ error: "ÁÑ°Âäπ„Å™ `machines` „Éá„Éº„Çø" });
  }

  // **ÁôªÈå≤Áî®„Éá„Éº„Çø„ÅÆÊï¥ÁêÜ**
  const values = machines.map(({ inputName, name_collection_id, sis_code, quantity }) => [
    competitorId, categoryId, inputName, name_collection_id, sis_code, quantity, updatedAt
  ]);

  // **„Éá„Éº„ÇøÁôªÈå≤**
  db.query(`
    INSERT INTO machine_data (competitor_id, category_id, machine_name, name_collection_id, sis_code, quantity, updated_at) 
    VALUES ? 
    ON DUPLICATE KEY UPDATE quantity = VALUES(quantity), updated_at = VALUES(updated_at)
  `, [values], (err) => {
    if (err) {
      console.error("‚ùå „Çπ„ÉÜ„Éº„Ç∏3„ÅÆÁôªÈå≤„Ç®„É©„Éº:", err);
      return res.status(500).json({ error: "„Çπ„ÉÜ„Éº„Ç∏3„ÅÆÁôªÈå≤„Ç®„É©„Éº" });
    }

    console.log("‚úÖ „Çπ„ÉÜ„Éº„Ç∏3„ÅÆ„Éá„Éº„Çø„ÇíÊ≠£Â∏∏„Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü");
    res.json({ message: "ÁôªÈå≤ÂÆå‰∫Ü" });
  });
});

// „Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞**
function insertOrUpdateMachineData(competitorId, category, categoryId, totalQuantity, machines, res) {
  const updatedAt = new Date().toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
  
  function basicNormalize(text) {
    return text
      .replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/„ÄÄ/g, ' ')
      .replace(/[~„ÄúÔΩû]/g, '')
      .replace(/[„Äê„Äë\[\]]/g, '')
      .replace(/[‚ÄêÔºçÔΩ∞\-]/g, '')
      .replace(/\s+/g, '')
      .trim();
  }

  function gameSpecificNormalize(text) {
    return text
      .replace(/„Å±„Å°„Çì„Åì|„Éë„ÉÅ„É≥„Ç≥/gi, '')
      .replace(/^(.\b)?„Éë„ÉÅ„Çπ„É≠/i, '$1')
      .replace(/^(.\b)?ÔæäÔæüÔæÅÔΩΩÔæõ/i, '$1')
      .replace(/^(.\b)?„Çπ„É≠„ÉÉ„Éà/i, '$1')
      .replace(/^(.\b)?ÔΩΩÔæõÔΩØÔæÑ/i, '$1')
      .replace(/^PACHISLOT|^pachislot/i, '')
      .replace(/^SLOT|^slot/i, '')
      .trim();
  }

  const cleanedMachines = machines.map(({ machine, quantity }) => ({
    originalName: machine,
    stage1Clean: basicNormalize(machine),
    stage2Clean: gameSpecificNormalize(basicNormalize(machine)),
    quantity
  }));

  const queries = cleanedMachines.map(({ originalName, stage1Clean, stage2Clean, quantity }) => {
    return new Promise((resolve, reject) => {
      // **name_collection_id „ÇíÂèñÂæó**
      const query = `
        SELECT id, sis_code FROM name_collection 
        WHERE REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
          dotcom_machine_name, '-', ''), '‚Äê', ''), 'Ôºç', ''), ' ', ''), '„ÄÄ', ''), '~', ''), '„Äú', ''), 'ÔΩû', ''), '„Äê', ''), '„Äë', '') 
        COLLATE utf8mb4_unicode_ci
        LIKE CONCAT('%', ?, '%')
        ORDER BY LENGTH(REGEXP_REPLACE(dotcom_machine_name, '„Äê.*?„Äë', '')) ASC 
        LIMIT 1
      `;

      db.query(query, [stage1Clean], (err, stage1Result) => {
        if (err) return reject(err);
        if (stage1Result.length > 0) {
          return resolve({
            inputName: originalName,
            name_collection_id: stage1Result[0].id,
            sis_code: stage1Result[0].sis_code,
            matchStage: 1,
            quantity
          });
        }

        db.query(query, [stage2Clean], (err, stage2Result) => {
          if (err) return reject(err);
          if (stage2Result.length > 0) {
            return resolve({
              inputName: originalName,
              name_collection_id: stage2Result[0].id,
              sis_code: stage2Result[0].sis_code,
              matchStage: 2,
              quantity
            });
          }

          // **Levenshtein Distance „ÅßÊúÄ„ÇÇËøë„ÅÑ„Éû„ÉÉ„ÉÅ„ÇíÂèñÂæó**
          db.query(`
            SELECT id, sis_code, dotcom_machine_name, LEVENSHTEIN_DISTANCE(
              REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
                dotcom_machine_name, '-', ''), '‚Äê', ''), 'Ôºç', ''), ' ', ''), '„ÄÄ', ''), '~', ''), '„Äú', ''), 'ÔΩû', ''), '„Äê', ''), '„Äë', ''), 
              ? COLLATE utf8mb4_unicode_ci
            ) AS distance 
            FROM name_collection 
            HAVING distance <= 5
            ORDER BY distance ASC, LENGTH(REGEXP_REPLACE(dotcom_machine_name, '„Äê.*?„Äë', '')) ASC
            LIMIT 1
          `, [stage2Clean], (err, stage3Result) => {
            if (err) return reject(err);

            resolve({
              inputName: originalName,
              name_collection_id: stage3Result.length > 0 ? stage3Result[0].id : null,
              sis_code: stage3Result.length > 0 ? stage3Result[0].sis_code : null,
              matchStage: stage3Result.length > 0 ? 3 : null,
              quantity
            });
          });
        });
      });
    });
  });

  Promise.all(queries)
    .then(results => {
      // **„Çπ„ÉÜ„Éº„Ç∏1„Éª2„ÅÆ„Éá„Éº„ÇøÔºàÁ¢∫ÂÆö„Åó„Å¶„ÅÑ„Çã„Éá„Éº„ÇøÔºâ**
      const stage1And2 = results.filter(r => r.matchStage === 1 || r.matchStage === 2);
      // **„Çπ„ÉÜ„Éº„Ç∏3„ÅÆ„Éá„Éº„ÇøÔºà„Éï„É≠„É≥„ÉàÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Éá„Éº„ÇøÔºâ**
      const stage3 = results.filter(r => r.matchStage === 3);

      // **„Çπ„ÉÜ„Éº„Ç∏1„Éª2„ÇíDB„Å´ÁôªÈå≤**
      if (stage1And2.length > 0) {
        const values = stage1And2.map(({ inputName, name_collection_id, sis_code, quantity }) => [
          competitorId, categoryId, inputName, name_collection_id, sis_code, quantity, updatedAt
        ]);

        db.query(`
          INSERT INTO machine_data 
          (competitor_id, category_id, machine_name, name_collection_id, sis_code, quantity, updated_at) 
          VALUES ? 
          ON DUPLICATE KEY UPDATE quantity = VALUES(quantity), updated_at = VALUES(updated_at)
        `, [values], (err) => {
          if (err) {
            console.error("‚ùå „Éá„Éº„ÇøÁôªÈå≤„Ç®„É©„Éº:", err);
            return res.status(500).json({ error: "„Éá„Éº„ÇøÁôªÈå≤„Ç®„É©„Éº" });
          }
          console.log("‚úÖ „Çπ„ÉÜ„Éº„Ç∏1„Éª2„ÅÆ„Éá„Éº„ÇøÁôªÈå≤ÊàêÂäü");
        });
      }

      // **„Çπ„ÉÜ„Éº„Ç∏1„Éª2„ÅÆ„Éá„Éº„ÇøÁôªÈå≤Âæå„Å´Á∑èÂè∞Êï∞„ÇíÊõ¥Êñ∞**
      const updateQuery = `UPDATE competitor_stores SET \`${category}\` = ? WHERE id = ?`;
      db.query(updateQuery, [totalQuantity, competitorId], (err, updateResult) => {
        if (err) {
          console.error("‚ùå Á∑èÂè∞Êï∞„ÅÆÊõ¥Êñ∞„Ç®„É©„Éº:", err);
          return res.status(500).json({ error: "Á∑èÂè∞Êï∞„ÅÆÊõ¥Êñ∞„Ç®„É©„Éº" });
        }
        console.log(`‚úÖ Á∑èÂè∞Êï∞ (${category}) „Çí ${totalQuantity} „Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`);
      });

      // **„Çπ„ÉÜ„Éº„Ç∏3„ÅÆ„Éá„Éº„Çø„Çí„Éï„É≠„É≥„Éà„Å´ÈÄÅ‰ø°**
      if (stage3.length === 0) {
        return res.json({
          message: "ÁôªÈå≤ÂÆå‰∫ÜÔºà„Çπ„ÉÜ„Éº„Ç∏3„ÅÆÁ¢∫Ë™ç„ÅØ‰∏çË¶ÅÔºâ",
          competitorId,
          category,
          categoryId,
          totalQuantity,
          updatedAt
        });
      }

      // **„Çπ„ÉÜ„Éº„Ç∏3„ÅÆ„Éá„Éº„Çø„Å´Èñ¢„Åó„Å¶„ÄÅË£úË∂≥ÊÉÖÂ†±ÔºàÊ©üÁ®ÆË©≥Á¥∞„Å™„Å©Ôºâ„ÇíÂèñÂæó**
      const nameCollectionIds = stage3.map(r => r.name_collection_id).filter(id => id !== null);

      if (nameCollectionIds.length > 0) {
        // **„Åæ„Åö name_collection „ÉÜ„Éº„Éñ„É´„Åã„Çâ sis_code „ÇíÂèñÂæó**
        db.query(`SELECT id, sis_code FROM name_collection WHERE id IN (?)`, [nameCollectionIds], (err, sisCodeResults) => {
          if (err) {
            console.error("‚ùå name_collection „Åã„Çâ sis_code „ÅÆÂèñÂæó„Ç®„É©„Éº:", err);
            return res.status(500).json({ error: "sis_code „ÅÆÂèñÂæó„Ç®„É©„Éº" });
          }

          // **ÂèñÂæó„Åó„Åü sis_code „ÇíÈÖçÂàó„Å´Â§âÊèõ**
          const sisCodes = sisCodeResults.map(row => row.sis_code).filter(code => code !== null);

          if (sisCodes.length === 0) {
            console.log("‚ùå name_collection „Åã„ÇâÂèñÂæó„Åó„Åü sis_code „ÅåÁ©∫„Åß„Åô");
            return res.json({
              message: "Á¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô",
              needsStage3Confirmation: true,
              competitorId,
              category,
              categoryId,
              totalQuantity,
              machines: stage3,
              machineDetails: [],
              updatedAt
            });
          }

          // **sis_code „Çí‰Ωø„Å£„Å¶ sis_machine_data „Åã„ÇâÂøÖË¶Å„Å™ÊÉÖÂ†±„ÇíÂèñÂæó**
          db.query(`
            SELECT sis_machine_code, sis_type_code, cr_category, sis_maker_code, sis_machine_name
            FROM sis_machine_data
            WHERE sis_machine_code IN (?)
          `, [sisCodes], (err, machineDetails) => {
            if (err) {
              console.error("‚ùå sis_machine_data „ÅÆÂèñÂæó„Ç®„É©„Éº:", err);
              return res.status(500).json({ error: "Ê©üÁ®ÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº" });
            }

            console.log("üõ† `/insertOrUpdateMachineData` „ÅßÈÄÅ„Çã„Éá„Éº„Çø:", {
              competitorId,
              category,
              categoryId,
              totalQuantity,
              machines: stage3,
              machineDetails,
              updatedAt
            });

            return res.json({
              message: "Á¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô",
              needsStage3Confirmation: true,
              competitorId,
              category,
              categoryId,
              totalQuantity,
              machines: stage3,
              machineDetails,
              updatedAt
            });
          });
        });
      } else {
        // **name_collection_id „Åå null „ÅÆÂ†¥ÂêàÔºàÂÆåÂÖ®„Å´‰∏ÄËá¥„Åó„Å™„ÅÑÔºâ**
        console.log("üõ† `/insertOrUpdateMachineData` „ÅßÈÄÅ„Çã„Éá„Éº„ÇøÔºàÂÆåÂÖ®„Å´‰∏ÄËá¥„Åó„Å™„ÅÑÔºâ:", {
          competitorId,
          category,
          categoryId,
          totalQuantity,
          machines: stage3,
          updatedAt
        });

        return res.json({
          message: "Á¢∫Ë™ç„ÅåÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô",
          needsStage3Confirmation: true,
          competitorId,
          category,
          categoryId,
          totalQuantity,
          machines: stage3,
          updatedAt
        });
      }
    })
    .catch(err => {
      console.error("‚ùå „Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº:", err);
      res.status(500).json({ error: "„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº" });
    });
}

// üìå Ëá™Â∫ó„Å®Á´∂ÂêàÂ∫ó„ÇíÂèñÂæó„Åô„ÇãAPI
app.get("/get-stores", (req, res) => {
  const query = `
    SELECT s.store_name, GROUP_CONCAT(c.competitor_name) AS competitors
    FROM stores s
    LEFT JOIN competitor_stores c ON s.id = c.store_id
    GROUP BY s.store_name;
  `;

  db.query(query, (err, results) => {
    if (err) {
      return res.status(500).json({ error: "„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº" });
    }

    // „Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíË™øÊï¥
    const storeList = results.map(row => ({
      name: row.store_name,
      competitors: row.competitors ? row.competitors.split(",") : []
    }));

    res.json(storeList);
  });
});

// üìå Á®ÆÂà•„ÇíÂèñÂæó„Åô„ÇãAPI
app.get("/get-types", (req, res) => {
  const query = "SELECT category_name FROM categories ORDER BY sort_order ASC";

  db.query(query, (err, results) => {
    if (err) {
      return res.status(500).json({ error: "„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº" });
    }

    const typeOptions = results.map(row => row.category_name);
    res.json(typeOptions);
  });
});

// üìå Á´∂ÂêàÂ∫ó„ÇíËøΩÂä†„Åô„ÇãAPI
app.post("/add-competitor", (req, res) => {
  const { storeName, competitorName } = req.body;

  // Ëá™Â∫óID„ÇíÂèñÂæó
  db.query("SELECT id FROM stores WHERE store_name = ?", [storeName], (err, storeResult) => {
    if (err || storeResult.length === 0) {
      return res.status(400).json({ error: "Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
    }
    const storeId = storeResult[0].id;

    // Á´∂ÂêàÂ∫ó„ÇíËøΩÂä†ÔºàÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÅÇ„ÇäÔºâ
    db.query(
      "INSERT INTO competitor_stores (store_id, competitor_name) VALUES (?, ?) ON DUPLICATE KEY UPDATE competitor_name = VALUES(competitor_name)",
      [storeId, competitorName],
      (err, result) => {
        if (err) {
          return res.status(500).json({ error: "Á´∂ÂêàÂ∫ó„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü" });
        }
        res.json({ message: "Á´∂ÂêàÂ∫ó„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü", competitorName });
      }
    );
  });
});

// üìå Ê©üÁ®ÆÊÉÖÂ†±„ÇíÂèñÂæó„Åô„ÇãAPI
app.get("/get-machines", (req, res) => {
  const { storeName, competitorName, category } = req.query;

  // Á´∂ÂêàÂ∫ó„Å®„Ç´„ÉÜ„Ç¥„É™„ÅÆID„ÇíÂèñÂæó
  db.query(
    "SELECT id FROM stores WHERE store_name = ?",
    [storeName],
    (err, storeResult) => {
      if (err || storeResult.length === 0) {
        console.error("‚ùå „Ç®„É©„Éº: Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return res.status(400).json({ error: "Ëá™Â∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
      }
      const storeId = storeResult[0].id;

      db.query(
        "SELECT id FROM competitor_stores WHERE store_id = ? AND competitor_name = ?",
        [storeId, competitorName],
        (err, compResult) => {
          if (err || compResult.length === 0) {
            console.error("‚ùå „Ç®„É©„Éº: Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
            return res.status(400).json({ error: "Á´∂ÂêàÂ∫ó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
          }
          const competitorId = compResult[0].id;

          db.query(
            "SELECT id FROM categories WHERE category_name = ?",
            [category],
            (err, catResult) => {
              if (err || catResult.length === 0) {
                console.error("‚ùå „Ç®„É©„Éº: „Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                return res.status(400).json({ error: "„Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì" });
              }
              const categoryId = catResult[0].id;

              // `machine_data` „Åã„ÇâÊúÄÊñ∞„ÅÆ `updated_at` „ÅÆ„É¨„Ç≥„Éº„Éâ„ÅÆ„ÅøÂèñÂæó
              const machineQuery = `
                SELECT machine_name, quantity, updated_at
                FROM machine_data
                WHERE competitor_id = ? AND category_id = ?
                AND updated_at = (
                  SELECT MAX(updated_at) 
                  FROM machine_data 
                  WHERE competitor_id = ? AND category_id = ?
                )
                ORDER BY quantity DESC
              `;

              db.query(machineQuery, [competitorId, categoryId, competitorId, categoryId], (err, results) => {
                if (err) {
                  console.error("‚ùå „Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:", err);
                  return res.status(500).json({ error: "„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº" });
                }

                res.json(results);
              });
            }
          );
        }
      );
    }
  );
});

// üìå Âè∞Êï∞„ÇíÊõ¥Êñ∞„Åô„ÇãAPI
app.post("/update-machine-quantity", (req, res) => {
  const { machineName, competitorName, category, quantity } = req.body;

  if (!machineName || !competitorName || !category || quantity === undefined) {
    return res.status(400).json({ error: "„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" });
  }

  // `quantity` „ÅÆ„ÅøÊõ¥Êñ∞ÔºàÊúÄÊñ∞„ÅÆ `updated_at` „ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÂØæË±°Ôºâ
  const query = `
    UPDATE machine_data 
    SET quantity = ?, updated_at = updated_at 
    WHERE machine_name = ? 
    AND competitor_id = (SELECT id FROM competitor_stores WHERE competitor_name = ?) 
    AND category_id = (SELECT id FROM categories WHERE category_name = ?)
    AND updated_at = (
      SELECT MAX(updated_at) FROM machine_data 
      WHERE machine_name = ? 
      AND competitor_id = (SELECT id FROM competitor_stores WHERE competitor_name = ?) 
      AND category_id = (SELECT id FROM categories WHERE category_name = ?)
    )
  `;

  db.query(
    query, 
    [quantity, machineName, competitorName, category, machineName, competitorName, category],
    (err, result) => {
      if (err) {
        console.error("‚ùå Êõ¥Êñ∞„Ç®„É©„Éº:", err);
        return res.status(500).json({ error: "„Éá„Éº„ÇøÊõ¥Êñ∞„Ç®„É©„Éº" });
      }

      if (result.affectedRows === 0) {
        return res.status(400).json({ error: "ÊúÄÊñ∞„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü" });
      }

      res.json({ message: "Âè∞Êï∞„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºàÊúÄÊñ∞„É¨„Ç≥„Éº„Éâ„ÅÆ„ÅøÂØæË±°„ÄÅÊõ¥Êñ∞Êó•ÊôÇ„ÅØÂ§âÊõ¥„Å™„ÅóÔºâ" });
    }
  );
});

// üìå „Çµ„Éº„Éê„ÉºËµ∑Âãï
app.listen(5000, () => console.log("„Çµ„Éº„Éê„Éº„Åå„Éù„Éº„Éà5000„ÅßËµ∑Âãï"));
